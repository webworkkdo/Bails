# Vulnerability Report

This document contains a list of vulnerabilities found in the codebase.

## 1. Call Spamming (Denial of Service)

**Impact:** An attacker can repeatedly send call requests to a user, causing their WhatsApp application to become unresponsive and eventually crash. This constitutes a Denial of Service (DoS) attack.

**Steps to Reproduce:**
1. An attacker using this library can call the `offerCall` function in a rapid loop.
2. The library will send a high volume of call stanzas to the victim.
3. The victim's WhatsApp client will be overwhelmed by the incoming call notifications, leading to performance degradation and eventual application crash.

**Vulnerable Code:**
- **File:** `lib/Socket/messages-recv.js`
- **Function:** `offerCall`
- **Issue:** This function does not implement any rate limiting or cooldown mechanism between call offers, allowing for abuse.
- **Function:** `handleCall`
- **Issue:** This function processes incoming call stanzas without checking the frequency of requests from a single user, making it susceptible to spamming attacks.

## 2. Resource Exhaustion via Message Abuse

**Impact:** An attacker can send a high volume of messages or specially crafted malformed messages to exhaust the recipient's device resources, such as CPU and memory. This can cause the WhatsApp application to become slow, unresponsive, or crash.

**Steps to Reproduce:**

**Scenario A: High Volume of Messages**
1. An attacker uses the library to send a large number of messages to the victim in a short period.
2. The victim's client is forced to process all incoming messages, leading to increased CPU and memory consumption.
3. Continuous message flooding will eventually lead to resource exhaustion and application failure.

**Scenario B: Malformed Messages and Retry Storm**
1. An attacker sends a message that is intentionally corrupted or fails decryption checks.
2. The `handleMessage` function on the recipient's client fails to decrypt the message and triggers the `sendRetryRequest` function.
3. The attacker can repeatedly send such messages, forcing the client into a "retry storm," where it continuously requests the server to resend the message, consuming network and processing resources.

**Vulnerable Code:**
- **File:** `lib/Socket/messages-recv.js`
- **Function:** `handleMessage`
- **Issue:** The function lacks proper validation for message size and frequency, making it vulnerable to message flooding attacks.
- **Function:** `sendRetryRequest`
- **Issue:** This function can be triggered repeatedly by malformed messages, creating a resource-intensive retry loop. There is a `maxMsgRetryCount`, but it can be bypassed by sending new malformed messages.

## 3. Group Management Abuse

**Impact:** An attacker with knowledge of the group ID can perform administrative actions without proper authorization. This can lead to disruption of group activities, removal of legitimate members, and spreading of misinformation by altering the group subject or description.

**Steps to Reproduce:**
1. An attacker, who does not need to be an admin of the group, can call the group management functions directly.
2. For example, an attacker could call `groupParticipantsUpdate` to remove a user from the group, `groupUpdateSubject` to change the group's name, or `groupUpdateDescription` to modify the group's description.
3. Since there are no permission checks in these functions, the library will execute these actions without verifying if the user has the necessary admin privileges.

**Vulnerable Code:**
- **File:** `lib/Socket/groups.js`
- **Functions:**
  - `groupParticipantsUpdate`
  - `groupUpdateSubject`
  - `groupUpdateDescription`
- **Issue:** These functions do not verify if the user issuing the request has administrative privileges in the group. They directly execute the requested action, allowing any user to perform admin-level tasks.

## 4. Invisible Call Crash

**Impact:** An attacker can initiate a call with a spoofed or invalid caller ID, causing the recipient's WhatsApp client to crash. Because the caller's identity is hidden, the victim has no way of knowing who is attacking them, making it difficult to block or report the user.

**Steps to Reproduce:**
1. An attacker can bypass the high-level `offerCall` function and use the lower-level `query` function to construct a raw call stanza.
2. In this stanza, the attacker can set the `call-creator` or `from` attribute to a non-existent or malformed JID (e.g., `0@s.whatsapp.net` or an empty string).
3. When the recipient's client receives this malformed stanza, it may fail to handle the invalid JID gracefully, leading to an application crash.

**Vulnerable Code:**
- **File:** `lib/Socket/messages-send.js` (and other files with access to the `query` function)
- **Function:** `query`
- **Issue:** The `query` function provides low-level access to the WhatsApp protocol without performing the necessary validation that higher-level functions like `offerCall` do. This allows a malicious user to send custom-crafted stanzas that can exploit parsing and handling vulnerabilities in the client application. The core issue is the lack of server-side validation for the `call-creator` attribute.

## 5. Infinite Crash & iOS-Specific Crash via Malformed Messages

**Impact:** An attacker can send a specially crafted message that crashes the recipient's WhatsApp client upon rendering. If the message is sent in a chat, it can cause the application to crash every time the chat is opened, effectively making the chat permanently inaccessible (an "infinite crash"). This can be targeted specifically at iOS devices, which are known to be vulnerable to certain character sequences (Unicode bombs).

**Steps to Reproduce:**
1. An attacker constructs a message containing a "Unicode bomb" or other known crash-inducing text.
2. The attacker uses the `sendMessage` function to send this malicious text to a victim. The text can be placed in any field that is rendered on the client, such as the body of a text message, the title of a list, or the content of a button.
3. When the victim's client, especially on iOS, attempts to render the message, the application's text rendering engine will fail and cause a crash.
4. Because the message is persisted in the chat history, the application will crash every time the user reopens that chat.

**Vulnerable Code:**
- **File:** `lib/Utils/messages.js`
- **Function:** `generateWAMessageContent`
- **Issue:** This function and its related utilities do not perform any sanitization on text inputs (e.g., in `extendedTextMessage`, `buttonsMessage`, `listMessage`). This allows an attacker to inject malicious strings that can crash the client's rendering engine. The library even contains a `getDevice` utility that could be used to specifically target iOS users.

## 6. Delay Bug & Performance Degradation via Oversized Messages

**Impact:** An attacker can send an exceptionally large or complex message, causing the recipient's WhatsApp client to consume excessive CPU and memory during processing. This leads to significant performance degradation, making the app slow, unresponsive, and laggy (a "delay bug") without causing a full crash.

**Steps to Reproduce:**
1. An attacker crafts a message that is valid in structure but extreme in size or complexity. Examples include:
    - A text message with an extremely long string (e.g., millions of characters).
    - A list message with thousands of sections or rows.
    - A message that mentions thousands of participants in its `contextInfo`.
2. The attacker sends this oversized message to the victim.
3. The victim's client attempts to parse and render the message, consuming a disproportionate amount of system resources, which results in a frozen or heavily delayed UI.

**Vulnerable Code:**
- **File:** `lib/Utils/messages.js`
- **Function:** `generateWAMessageContent`
- **Issue:** The function does not enforce any size or complexity limits on the content being prepared. It fails to validate the length of text fields, the number of items in lists, or the number of mentioned JIDs, allowing a malicious user to construct and send messages that are designed to exhaust the client's processing resources.
